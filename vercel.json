import React, { useState, useRef, useEffect, useCallback } from 'react';
import { 
  Play, 
  Trash2, 
  Activity, 
  Globe, 
  MessageSquare, 
  Clock, 
  FileJson,
  CheckCircle,
  XCircle,
  Loader2,
  Sparkles,
  Database,
  Zap,
  Layers,
  ChevronRight,
  Search,
  Mail,
  HardDrive,
  User,
  LogIn,
  Key,
  AlertTriangle,
  MousePointer2,
  X,
  Plus
} from 'lucide-react';

// --- Configuration ---
const GEMINI_MODEL = "gemini-2.0-flash-exp"; // Modèle optimisé pour la rapidité
const API_KEY_PLACEHOLDER = ""; // La clé est injectée par l'environnement

// --- Types ---
type NodeType = 'webhook' | 'httpRequest' | 'discord' | 'wait' | 'json' | 'ai' | 'gmail' | 'memory';

const NODE_TYPES: Record<NodeType, any> = {
  webhook: {
    label: 'Webhook',
    category: 'Triggers',
    icon: Globe,
    color: '#8357FF',
    initialConfig: { method: 'GET', path: '/webhook/incoming' },
  },
  gmail: {
    label: 'Gmail',
    category: 'Communication',
    icon: Mail,
    color: '#EA4335',
    initialConfig: { 
      mode: 'simulation',
      operation: 'read', 
      limit: 3, 
      accessToken: '', 
      userAccount: 'Compte Simulation'
    },
  },
  ai: {
    label: 'IA Gemini',
    category: 'AI',
    icon: Sparkles,
    color: '#00A3FF',
    initialConfig: { 
      systemPrompt: "Tu es un assistant personnel intelligent.", 
      userPrompt: "Analyse cet email et propose une réponse courte : {{input}}" 
    },
  },
  memory: {
    label: 'Mémoire (DB)',
    category: 'Storage',
    icon: HardDrive,
    color: '#FF9F43',
    initialConfig: { 
      operation: 'write',
      key: 'contexte_client',
      value: '{{input}}'
    },
  },
  httpRequest: {
    label: 'HTTP Request',
    category: 'Services',
    icon: Activity,
    color: '#FF4D4D',
    initialConfig: { url: 'https://jsonplaceholder.typicode.com/todos/1', method: 'GET' },
  },
  discord: {
    label: 'Discord',
    category: 'Communication',
    icon: MessageSquare,
    color: '#5865F2',
    initialConfig: { content: 'Workflow terminé avec succès !' },
  },
  wait: {
    label: 'Attendre',
    category: 'Flow',
    icon: Clock,
    color: '#FFB800',
    initialConfig: { ms: 1500 },
  },
  json: {
    label: 'Code / JSON',
    category: 'Transform',
    icon: FileJson,
    color: '#00D1FF',
    initialConfig: { json: '{"processed": true}' },
  }
};

const sleep = (ms: number) => new Promise(r => setTimeout(r, ms));

export default function App() {
  const [nodes, setNodes] = useState<any[]>([
    { id: 'webhook_1', type: 'webhook', x: 100, y: 200, config: NODE_TYPES.webhook.initialConfig, status: 'idle' },
    { id: 'ai_1', type: 'ai', x: 450, y: 200, config: NODE_TYPES.ai.initialConfig, status: 'idle' }
  ]);
  const [edges, setEdges] = useState<any[]>([
    { id: 'e1', source: 'webhook_1', target: 'ai_1' }
  ]);
  
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [isExecuting, setIsExecuting] = useState(false);
  const [dragInfo, setDragInfo] = useState<{id: string} | null>(null);
  const [connecting, setConnecting] = useState<{id: string, x: number, y: number} | null>(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const [logs, setLogs] = useState<any[]>([]);
  
  const canvasRef = useRef<HTMLDivElement>(null);

  const addLog = (msg: string, type: 'info' | 'error' = 'info') => {
    setLogs(prev => [{ t: new Date().toLocaleTimeString(), msg, type }, ...prev.slice(0, 50)]);
  };

  const onMouseMove = (e: React.MouseEvent) => {
    const rect = canvasRef.current?.getBoundingClientRect();
    if (!rect) return;
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    setMousePos({ x, y });

    if (dragInfo) {
      setNodes(nds => nds.map(n => n.id === dragInfo.id ? { ...n, x: x - 100, y: y - 40 } : n));
    }
  };

  const createNode = (type: NodeType) => {
    const id = `${type}_${Math.random().toString(36).substr(2, 5)}`;
    const newNode = {
      id,
      type,
      x: 100 + Math.random() * 50,
      y: 100 + Math.random() * 50,
      config: { ...NODE_TYPES[type].initialConfig },
      status: 'idle',
      output: null
    };
    setNodes(prev => [...prev, newNode]);
    setSelectedId(id);
  };

  const execute = async () => {
    setIsExecuting(true);
    addLog("Démarrage du flux de travail...");
    setNodes(nds => nds.map(n => ({ ...n, status: 'idle', output: null })));

    for (const node of nodes) {
      setNodes(nds => nds.map(n => n.id === node.id ? { ...n, status: 'running' } : n));
      await sleep(1000);
      setNodes(nds => nds.map(n => n.id === node.id ? { ...n, status: 'success', output: { success: true, timestamp: Date.now() } } : n));
      addLog(`Nœud ${node.label || node.type} exécuté.`);
    }

    setIsExecuting(false);
    addLog("Workflow terminé.");
  };

  return (
    <div className="flex flex-col h-screen bg-[#F8FAFC] text-[#1E293B] font-sans overflow-hidden">
      {/* HEADER */}
      <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 z-50 shadow-sm">
        <div className="flex items-center gap-4">
          <div className="bg-[#6366F1] p-2 rounded-xl shadow-indigo-100 shadow-lg">
            <Zap size={24} className="text-white fill-white" />
          </div>
          <div>
            <h1 className="text-lg font-bold tracking-tight">OpenFlow Engine</h1>
            <p className="text-[11px] text-slate-400 font-semibold uppercase tracking-widest">Studio d'Automatisation</p>
          </div>
        </div>
        
        <div className="flex items-center gap-4">
          <button 
            onClick={execute}
            disabled={isExecuting}
            className={`flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm transition-all shadow-md active:scale-95 ${isExecuting ? 'bg-slate-100 text-slate-400' : 'bg-[#6366F1] text-white hover:bg-[#4F46E5] hover:shadow-indigo-200'}`}
          >
            {isExecuting ? <Loader2 size={18} className="animate-spin" /> : <Play size={18} className="fill-white" />}
            {isExecuting ? 'En cours...' : 'Lancer le flux'}
          </button>
        </div>
      </header>

      <div className="flex flex-1 relative overflow-hidden">
        {/* CANVAS */}
        <main 
          ref={canvasRef}
          className="flex-1 relative bg-slate-50 overflow-hidden cursor-crosshair"
          onMouseMove={onMouseMove}
          onMouseUp={() => { setDragInfo(null); setConnecting(null); }}
          style={{ 
            backgroundImage: 'radial-gradient(#CBD5E1 1px, transparent 1px)',
            backgroundSize: '30px 30px'
          }}
        >
          {/* SVG Connections */}
          <svg className="absolute inset-0 w-full h-full pointer-events-none">
            {edges.map(edge => {
              const s = nodes.find(n => n.id === edge.source);
              const t = nodes.find(n => n.id === edge.target);
              if (!s || !t) return null;
              return (
                <path 
                  key={edge.id}
                  d={`M ${s.x + 200} ${s.y + 40} C ${s.x + 280} ${s.y + 40}, ${t.x - 80} ${t.y + 40}, ${t.x} ${t.y + 40}`}
                  stroke="#94A3B8" strokeWidth="2.5" fill="none"
                />
              );
            })}
          </svg>

          {/* Nodes */}
          {nodes.map(node => {
            const typeInfo = NODE_TYPES[node.type as NodeType];
            return (
              <div 
                key={node.id}
                onMouseDown={() => { setSelectedId(node.id); setDragInfo({ id: node.id }); }}
                style={{ left: node.x, top: node.y }}
                className={`absolute w-56 bg-white rounded-2xl shadow-xl border-2 transition-all ${selectedId === node.id ? 'border-indigo-500 ring-4 ring-indigo-50' : 'border-slate-100 hover:border-slate-300'}`}
              >
                <div className="p-4 flex items-center gap-3">
                  <div className="p-2.5 rounded-lg text-white shadow-inner" style={{ backgroundColor: typeInfo.color }}>
                    {React.createElement(typeInfo.icon, { size: 20 })}
                  </div>
                  <div>
                    <h3 className="text-sm font-bold">{typeInfo.label}</h3>
                    <p className="text-[10px] text-slate-400 font-mono">{node.id}</p>
                  </div>
                </div>
                {node.status !== 'idle' && (
                  <div className="px-4 pb-3 flex items-center justify-between border-t border-slate-50 pt-2">
                    <span className="text-[10px] font-bold uppercase text-slate-400">Statut</span>
                    {node.status === 'running' && <Loader2 size={14} className="animate-spin text-indigo-500" />}
                    {node.status === 'success' && <CheckCircle size={14} className="text-emerald-500" />}
                  </div>
                )}
              </div>
            );
          })}

          {/* Floating Menu */}
          <div className="absolute bottom-10 right-10 flex flex-col gap-3">
            <div className="bg-white p-4 rounded-3xl shadow-2xl border border-slate-100">
               <div className="grid grid-cols-4 gap-4">
                  {Object.keys(NODE_TYPES).map(type => (
                    <button 
                      key={type} 
                      onClick={() => createNode(type as NodeType)}
                      className="p-3 hover:bg-slate-50 rounded-2xl transition-all flex flex-col items-center gap-1 group"
                    >
                      <div className="p-2 rounded-lg text-white group-hover:scale-110 transition-transform" style={{ backgroundColor: NODE_TYPES[type as NodeType].color }}>
                        {React.createElement(NODE_TYPES[type as NodeType].icon, { size: 16 })}
                      </div>
                    </button>
                  ))}
               </div>
            </div>
          </div>
        </main>

        {/* LOGS */}
        <div className="w-80 bg-white border-l border-slate-200 flex flex-col">
          <div className="p-5 border-b border-slate-100 flex items-center justify-between">
            <h2 className="text-sm font-bold uppercase tracking-wider text-slate-500">Console Système</h2>
            <Activity size={16} className="text-slate-300" />
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-3 font-mono text-[11px]">
            {logs.map((log, i) => (
              <div key={i} className={`p-2 rounded-lg ${log.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-slate-50 text-indigo-600'}`}>
                <span className="opacity-50 mr-2">{log.t}</span> {log.msg}
              </div>
            ))}
            {logs.length === 0 && <p className="text-slate-300 italic text-center mt-10">Aucun log récent</p>}
          </div>
        </div>
      </div>
    </div>
  );
}
